name: Build SingBox 1.12.14 Final Victory
on: workflow_dispatch

jobs:
  build:
    # ğŸ”´ ä½¿ç”¨ macos-15 ä»¥ç¡®ä¿ç¯å¢ƒæœ€æ–°
    runs-on: macos-15
    steps:
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'microsoft'
          java-version: '17'
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      # ğŸŸ¢ æ ¸å¿ƒä¿®å¤ï¼šUI å’Œ å†…æ ¸å…¨éƒ¨é”å®šåˆ° 1.12.14 å‘å¸ƒæ—¶çš„çŠ¶æ€ï¼Œé˜²æ­¢æœ€æ–°ä»£ç çš„ç­¾åå‘
      - name: Clone Version-Matched Source
        run: |
          # å…‹éš† 1.12.14 ç‰ˆæœ¬å¯¹åº”çš„ UI æºç 
          git clone --branch v1.12.14 --recursive --depth 1 https://github.com/SagerNet/sing-box-for-apple.git ui-project
          # å…‹éš† 1.12.14 å†…æ ¸æºç 
          git clone --branch v1.12.14 --depth 1 https://github.com/SagerNet/sing-box.git core-project

      - name: Build 1.12.14 Core
        run: |
          go install github.com/sagernet/gomobile/cmd/gomobile@latest
          go install github.com/sagernet/gomobile/cmd/gobind@latest
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
          $(go env GOPATH)/bin/gomobile init
          
          cd core-project
          # ç°åœºç£¨åˆ¶é›¶ä»¶
          gomobile bind -v -target ios ./
          
          # æ ¹æ®ä¸åŒç‰ˆæœ¬ UI çš„éœ€æ±‚ï¼ŒåŒæ—¶ç”Ÿæˆä¸¤ä¸ªåç§°çš„é›¶ä»¶ä»¥é˜²ä¸‡ä¸€
          mkdir -p ../ui-project/Library/sing-box
          cp -rf *.xcframework ../ui-project/Library/sing-box/
          cp -rf *.xcframework ../ui-project/Libbox.xcframework

      - name: Clean Xcode Projects
        run: |
          cd ui-project
          # å½»åº•ç§»é™¤æ‰€æœ‰éœ€è¦è¯ä¹¦æƒé™çš„éæ ¸å¿ƒæ‰©å±•
          rm -rf Extension IntentsExtension WidgetExtension TVExtension FileProviderExtension Shared
          xcodebuild -resolvePackageDependencies

      - name: Final Xcode Synthesis
        run: |
          cd ui-project
          # ä½¿ç”¨æœ€çº¯å‡€çš„ SFI æ–¹æ¡ˆç¼–è¯‘
          xcodebuild -project sing-box.xcodeproj \
                     -scheme SFI \
                     -configuration Release \
                     -sdk iphoneos \
                     CODE_SIGNING_ALLOWED=NO \
                     CODE_SIGNING_REQUIRED=NO \
                     CODE_SIGN_IDENTITY="" \
                     CODE_SIGN_ENTITLEMENTS="" \
                     GCC_PREPROCESSOR_DEFINITIONS='$GCC_PREPROCESSOR_DEFINITIONS SFI_MAIN_ONLY=1' \
                     clean archive -archivePath build/sing-box.xcarchive

      - name: Export IPA
        run: |
          mkdir -p Payload
          APP_PATH=$(find ui-project/build/sing-box.xcarchive -name "*.app" | head -n 1)
          cp -rp "$APP_PATH" Payload/
          zip -r sing-box-1.12.14-stable.ipa Payload/

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: SingBox-Result
          path: sing-box-1.12.14-stable.ipa
