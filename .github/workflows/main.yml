name: Build SingBox Latest-Ultimate
on: workflow_dispatch

jobs:
  build:
    # ğŸ”´ æ ¸å¿ƒä¿®å¤ 1ï¼šå¿…é¡»ä½¿ç”¨ macOS 15 ä»¥æ”¯æŒæœ€æ–° Xcode å·¥ç¨‹æ ¼å¼
    runs-on: macos-15
    steps:
      # 1. ğŸŸ¢ ç¯å¢ƒå¼ºè¡Œé”æ­»
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'microsoft'
          java-version: '17'
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      # 2. ğŸŸ¢ çº¯å‡€å…‹éš†ï¼šè·å–æœ€æ–°å…¨å¥—æºç 
      - name: Clone Sources
        run: |
          git clone --recursive --depth 1 https://github.com/SagerNet/sing-box-for-apple.git ui-src
          git clone --depth 1 https://github.com/SagerNet/sing-box.git core-src

      # 3. ğŸ”´ ç»æ€ï¼šæŒ‰ç…§æœ€æ–°ç‰ˆè·¯å¾„ç›´æ¥æ„å»ºæ ¸å¿ƒé›¶ä»¶
      - name: Build Latest Core
        run: |
          go install github.com/sagernet/gomobile/cmd/gomobile@latest
          go install github.com/sagernet/gomobile/cmd/gobind@latest
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
          $(go env GOPATH)/bin/gomobile init
          
          cd core-src
          # ğŸŸ¢ æœ€æ–°ç‰ˆ 100% å­˜åœ¨æ­¤è·¯å¾„ï¼Œç›´æ¥è°ƒç”¨å®˜æ–¹ Apple æ„å»ºè„šæœ¬
          go run ./cmd/apple framework -v
          
          # ğŸ”´ å…³é”®ï¼šé‡å‘½åé›¶ä»¶ä»¥åŒæ—¶æ»¡è¶³æ–°æ—§ UI çš„ä¸åŒæœŸå¾…
          cp -rf *.xcframework ../ui-src/Libbox.xcframework
          mkdir -p ../ui-src/Library/sing-box
          cp -rf *.xcframework ../ui-src/Library/sing-box/

      # 4. ğŸ”´ ç‰©ç†éš”ç¦»ï¼šå½»åº•åˆ é™¤ä¼šå¯¼è‡´ Exit code 65 çš„ç»„ä»¶
      - name: Purge Disruptive Extensions
        run: |
          cd ui-src
          # å¼ºè¡Œç§»é™¤äº‘ç«¯æ— è¯ä¹¦ç¯å¢ƒä¸‹æ— æ³•ç¼–è¯‘çš„æ‰€æœ‰æ’ä»¶
          rm -rf Extension IntentsExtension WidgetExtension TVExtension FileProviderExtension Shared
          # å¼ºåˆ¶é¢„è§£æ Swift ä¾èµ–åŒ…
          xcodebuild -resolvePackageDependencies

      # 5. ğŸŸ¢ Xcode æœ€ç»ˆåˆæˆ (æ— ç­¾åçº¯å‡€æ¨¡å¼)
      - name: Xcode Synthesis
        run: |
          cd ui-src
          xcodebuild -project sing-box.xcodeproj \
                     -scheme SFI \
                     -configuration Release \
                     -sdk iphoneos \
                     CODE_SIGNING_ALLOWED=NO \
                     CODE_SIGNING_REQUIRED=NO \
                     CODE_SIGN_IDENTITY="" \
                     CODE_SIGN_ENTITLEMENTS="" \
                     GCC_PREPROCESSOR_DEFINITIONS='$GCC_PREPROCESSOR_DEFINITIONS SFI_MAIN_ONLY=1' \
                     clean archive -archivePath build/sing-box.xcarchive

      # 6. ğŸŸ¢ äº§å‡º IPA
      - name: Export for TrollStore
        run: |
          mkdir -p Payload
          APP_PATH=$(find ui-src/build/sing-box.xcarchive -name "*.app" | head -n 1)
          cp -rp "$APP_PATH" Payload/
          zip -r sing-box-latest-victory.ipa Payload/

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: SingBox-Latest-IPA
          path: sing-box-latest-victory.ipa
