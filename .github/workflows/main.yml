name: Build SingBox 1.12.14 Final Victory
on: workflow_dispatch

jobs:
  build:
    runs-on: macos-14
    steps:
      # 1. ğŸŸ¢ å¼ºè¡Œå¯¹ä½ Java 17 (è§£å†³ FATAL æŠ¥é”™)
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'microsoft'
          java-version: '17'

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      # 2. ğŸŸ¢ çº¯å‡€å…‹éš†ï¼šç›´æ¥å…‹éš†åˆ°æ ¹ç›®å½•ï¼Œä¸è®¾å­æ–‡ä»¶å¤¹
      - name: Clone Clean Source
        run: |
          git clone https://github.com/SagerNet/sing-box-for-apple.git ui-project
          git clone --branch v1.12.14 --depth 1 https://github.com/SagerNet/sing-box.git core-project

      # 3. ğŸ”´ ç»æ€ï¼šåœ°æ¯¯å¼æœç´¢ç¼–è¯‘å…¥å£
      - name: Build Core Framework
        run: |
          go install github.com/sagernet/gomobile/cmd/gomobile@latest
          go install github.com/sagernet/gomobile/cmd/gobind@latest
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
          $(go env GOPATH)/bin/gomobile init
          
          # ğŸŸ¢ ä¸å†æ‰‹åŠ¨æŒ‡å®š cd è·¯å¾„ï¼Œè€Œæ˜¯è®© find å»æŠ“å–çœŸæ­£çš„ cmd/apple ä½ç½®
          REAL_PATH=$(find $(pwd)/core-project -name "apple" -type d | grep "cmd/apple" | head -n 1)
          echo "æ‰¾åˆ°äº†çœŸå®è·¯å¾„: $REAL_PATH"
          
          if [ -z "$REAL_PATH" ]; then
            echo "é”™è¯¯ï¼šå…¨ç›˜æœç´¢ä¹Ÿæ²¡æ‰¾åˆ° cmd/appleï¼Œè¯·æ£€æŸ¥æºç æ˜¯å¦å®Œæ•´ï¼"
            exit 1
          fi
          
          cd "$REAL_PATH"
          # ç°åœºç¼–è¯‘ 1.12.14 å†…æ ¸
          go run . framework -v
          
          # æ¬è¿æˆæœ
          mkdir -p $GITHUB_WORKSPACE/ui-project/Library/sing-box
          cp -rf *.xcframework $GITHUB_WORKSPACE/ui-project/Library/sing-box/

      # 4. ğŸŸ¢ Xcode æœ€ç»ˆåˆæˆ
      - name: Xcode Synthesis
        run: |
          cd ui-project
          rm -rf Extension IntentsExtension WidgetExtension TVExtension
          xcodebuild -project sing-box.xcodeproj \
                     -scheme SFI \
                     -configuration Release \
                     -sdk iphoneos \
                     CODE_SIGNING_ALLOWED=NO \
                     CODE_SIGNING_REQUIRED=NO \
                     FRAMEWORK_SEARCH_PATHS="$(pwd)/Library/sing-box" \
                     clean archive -archivePath build/sing-box.xcarchive

      # 5. ğŸŸ¢ æ‰“åŒ…äº§å‡º
      - name: Export IPA
        run: |
          mkdir -p Payload
          APP_PATH=$(find ui-project/build/sing-box.xcarchive -name "*.app" | head -n 1)
          cp -rp "$APP_PATH" Payload/
          zip -r sing-box-1.12.14-stable.ipa Payload/

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: SingBox-Result
          path: sing-box-1.12.14-stable.ipa
