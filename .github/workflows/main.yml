name: Build SingBox 1.12.14 Victory-Final
on: workflow_dispatch

jobs:
  build:
    # ğŸ”´ æ ¸å¿ƒä¿®å¤ï¼šå¿…é¡»ä½¿ç”¨ macOS 15 ä»¥æ”¯æŒæœ€æ–°é¡¹ç›®æ ¼å¼ (Format 70)
    runs-on: macos-15
    steps:
      # 1. ğŸŸ¢ ç¯å¢ƒé”æ­» (åŸºäºäºŒè¿›åˆ¶æŒ‡çº¹çš„ Go 1.22)
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'microsoft'
          java-version: '17'
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      # 2. ğŸŸ¢ å…‹éš† 1.12.14 æ ¸å¿ƒä¸æœ€æ–° UI
      - name: Clone Sources
        run: |
          git clone --recursive --depth 1 https://github.com/SagerNet/sing-box-for-apple.git ui-src
          git clone --branch v1.12.14 --depth 1 https://github.com/SagerNet/sing-box.git core-src

      # 3. ğŸ”´ ç»æ€ç¼–è¯‘ï¼šå¼ºåˆ¶å°è£…ä¸º Library.xcframework (å¯¹ä½ä½ æ‰‹æœºé‡Œçš„é›¶ä»¶å)
      - name: Build Core (Library Match)
        run: |
          go install github.com/sagernet/gomobile/cmd/gomobile@latest
          go install github.com/sagernet/gomobile/cmd/gobind@latest
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
          $(go env GOPATH)/bin/gomobile init
          
          cd core-src
          # æ‰§è¡Œ 1.12.14 åŸå§‹æ„å»ºé€»è¾‘
          gomobile bind -v -target ios ./
          
          # ğŸ”´ æ ¸å¿ƒä¿®å¤ï¼šæŒ‰ç…§ä½ æä¾›çš„é›¶ä»¶åï¼Œå¼ºåˆ¶æ”¹å
          ORIGINAL_FRAMEWORK=$(find . -name "*.xcframework" | head -n 1)
          cp -rf "$ORIGINAL_FRAMEWORK" ../ui-src/Library.xcframework
          
          # ç‰©ç†åŒæ­¥åˆ°æ‰€æœ‰å¯èƒ½è¢«å¼•ç”¨åˆ°çš„è·¯å¾„ï¼ŒåŒ…æ‹¬ Libbox å’Œ Library/sing-box
          mkdir -p ../ui-src/Library/sing-box
          cp -rf "$ORIGINAL_FRAMEWORK" ../ui-src/Library/sing-box/
          cp -rf "$ORIGINAL_FRAMEWORK" ../ui-src/Libbox.xcframework

      # 4. ğŸ”´ ç»æ€ï¼šæ‰‹æœ¯çº§ä¿®æ”¹é¡¹ç›®å·¥ç¨‹ï¼Œå½»åº•æ ¹é™¤ Code 65
      - name: Hard-Purge & Re-Link
        run: |
          cd ui-src
          # 1. ç‰©ç†åˆ é™¤æ‰€æœ‰ä¼šå¯¼è‡´ç­¾åæŠ¥é”™çš„æ’ä»¶æ–‡ä»¶å¤¹
          rm -rf Extension IntentsExtension WidgetExtension TVExtension FileProviderExtension Shared
          
          # 2. å¼ºåˆ¶æŠ¹é™¤å·¥ç¨‹æ–‡ä»¶ä¸­å…³äºè¿™äº›æ’ä»¶çš„æ‰€æœ‰å¼•ç”¨å’Œç¼–è¯‘ç›®æ ‡
          # ä½¿ç”¨æ›´å½»åº•çš„æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…åˆ é™¤ï¼Œè®© Xcode å½»åº•â€œå¤±å¿†â€
          sed -i '' '/"Extension"/d' sing-box.xcodeproj/project.pbxproj
          sed -i '' '/"Widget"/d' sing-box.xcodeproj/project.pbxproj
          sed -i '' '/"Intents"/d' sing-box.xcodeproj/project.pbxproj
          sed -i '' '/"FileProvider"/d' sing-box.xcodeproj/project.pbxproj
          
          # 3. è§£æä¾èµ–
          xcodebuild -resolvePackageDependencies

      # 5. ğŸŸ¢ Xcode æœ€ç»ˆåˆæˆ (æ— ç­¾å/æ ¸å¿ƒæ¨¡å¼)
      - name: Xcode Synthesis
        run: |
          cd ui-src
          # ä½¿ç”¨çº¯å‡€æ¨¡å¼ç¼–è¯‘ï¼Œç¦ç”¨æ‰€æœ‰è‡ªåŠ¨ç­¾åå’Œé¢å¤–æ’ä»¶é“¾æ¥
          xcodebuild -project sing-box.xcodeproj \
                     -scheme SFI \
                     -configuration Release \
                     -sdk iphoneos \
                     CODE_SIGNING_ALLOWED=NO \
                     CODE_SIGNING_REQUIRED=NO \
                     CODE_SIGN_IDENTITY="" \
                     CODE_SIGN_ENTITLEMENTS="" \
                     GCC_PREPROCESSOR_DEFINITIONS='$GCC_PREPROCESSOR_DEFINITIONS SFI_MAIN_ONLY=1' \
                     clean archive -archivePath build/sing-box.xcarchive

      # 6. ğŸŸ¢ äº§å‡ºæˆå“ IPA
      - name: Export Final Result
        run: |
          mkdir -p Payload
          APP_PATH=$(find ui-src/build/sing-box.xcarchive -name "*.app" | head -n 1)
          cp -rp "$APP_PATH" Payload/
          zip -r sing-box-1.12.14-victory.ipa Payload/

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SingBox-Match-Result
          path: sing-box-1.12.14-victory.ipa
