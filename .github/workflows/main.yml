name: Build SingBox 1.12.14 Victory-Final
on: workflow_dispatch

jobs:
  build:
    runs-on: macos-14
    steps:
      # 1. ğŸŸ¢ ç¯å¢ƒå¼ºè¡Œå¯¹ä½ (Java 17 æ˜¯æ»¡è¶³ gomobile çš„å”¯ä¸€æ¡ä»¶)
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'microsoft'
          java-version: '17'
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      # 2. ğŸŸ¢ æºç å¼ºè¡Œå¯¹ä½ (æ‰‹åŠ¨æŒ‡å®šç›®å½•ï¼Œé˜²æ­¢æ–‡ä»¶å¤¹åµŒå¥—)
      - name: Clone Clean Source
        run: |
          # å…‹éš†ä¸» App UI
          git clone https://github.com/SagerNet/sing-box-for-apple.git main-app
          # å…‹éš†å†…æ ¸æºç åˆ°æŒ‡å®šæ–‡ä»¶å¤¹ï¼Œä¸ä½¿ç”¨é»˜è®¤å
          git clone --branch v1.12.14 --depth 1 https://github.com/SagerNet/sing-box.git singbox-core

      # 3. ğŸ”´ æ ¸å¿ƒå¯¹å†²ï¼šè§£å†³è·¯å¾„ç¼ºå¤±ä¸æ¨¡å—æŠ¥é”™
      - name: Build Core Framework
        run: |
          # å®‰è£…ç¼–è¯‘å·¥å…·
          go install github.com/sagernet/gomobile/cmd/gomobile@latest
          go install github.com/sagernet/gomobile/cmd/gobind@latest
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
          $(go env GOPATH)/bin/gomobile init
          
          # ğŸŸ¢ ä¿®æ­£ç‚¹ 1ï¼šè¿›å…¥åŒ…å« go.mod çš„æ ¹ç›®å½•ç¡®ä¿æ¨¡å—ä¸Šä¸‹æ–‡æ­£ç¡®
          cd singbox-core
          
          # ğŸŸ¢ ä¿®æ­£ç‚¹ 2ï¼šä½¿ç”¨ç»å¯¹åŒ…è·¯å¾„è¿è¡Œç¼–è¯‘è„šæœ¬ï¼Œå½»åº•é¿å¼€ "not a main package"
          go run ./cmd/apple framework -v
          
          # ğŸŸ¢ ä¿®æ­£ç‚¹ 3ï¼šæ¬è¿æˆæœåˆ° UI é¡¹ç›®
          mkdir -p ../main-app/Library/sing-box
          cp -rf *.xcframework ../main-app/Library/sing-box/

      # 4. ğŸŸ¢ æœ€ç»ˆ Xcode åˆæˆ
      - name: Xcode Final Synthesis
        run: |
          cd main-app
          # å½»åº•æ¸…é™¤å¹²æ‰°é¡¹
          rm -rf Extension IntentsExtension WidgetExtension TVExtension
          
          # å¼ºåˆ¶ç¼–è¯‘ IPA
          xcodebuild -project sing-box.xcodeproj \
                     -scheme SFI \
                     -configuration Release \
                     -sdk iphoneos \
                     CODE_SIGNING_ALLOWED=NO \
                     CODE_SIGNING_REQUIRED=NO \
                     FRAMEWORK_SEARCH_PATHS="$(pwd)/Library/sing-box" \
                     clean archive -archivePath build/sing-box.xcarchive

      # 5. ğŸŸ¢ æ‰“åŒ…äº§å‡º
      - name: Export IPA
        run: |
          mkdir -p Payload
          APP_PATH=$(find main-app/build/sing-box.xcarchive -name "*.app" | head -n 1)
          cp -rp "$APP_PATH" Payload/
          zip -r sing-box-1.12.14-stable.ipa Payload/

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: SingBox-1.12.14-Success
          path: sing-box-1.12.14-stable.ipa
