name: Build SingBox 1.12.14 Final Victory (Library Mode)
on: workflow_dispatch

jobs:
  build:
    # ğŸ”´ æ ¸å¿ƒä¿®å¤ï¼šå¿…é¡»ä½¿ç”¨ macOS 15 é•œåƒï¼Œæ”¯æŒ Xcode 16 (è§£å†³é¡¹ç›®æ ¼å¼ 70 æŠ¥é”™)
    runs-on: macos-15
    steps:
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'microsoft'
          java-version: '17'

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      # 1. ğŸŸ¢ çº¯å‡€å…‹éš†ï¼šæ‹‰å– 1.12.14 å†…æ ¸
      - name: Clone Sources
        run: |
          git clone --recursive --depth 1 https://github.com/SagerNet/sing-box-for-apple.git ui-project
          git clone --branch v1.12.14 --depth 1 https://github.com/SagerNet/sing-box.git core-project

      # 2. ğŸ”´ ç»æ€ï¼šæŒ‰ç…§æå–æ ·æœ¬çš„ç‰©ç†ç»“æ„å°è£…å†…æ ¸
      - name: Build Core (Matched to Phone Sample)
        run: |
          go install github.com/sagernet/gomobile/cmd/gomobile@latest
          go install github.com/sagernet/gomobile/cmd/gobind@latest
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
          $(go env GOPATH)/bin/gomobile init
          
          cd core-project
          # ğŸŸ¢ è¿è¡Œ 1.12.x å®˜æ–¹åŸç”Ÿç¼–è¯‘é€»è¾‘
          go run ./cmd/apple framework -v
          
          # ğŸ”´ å…³é”®å¯¹ä½ï¼šå°†ç”Ÿæˆçš„é›¶ä»¶å¼ºåˆ¶æ”¹åä¸ºä½ æå–å‡ºæ¥çš„ Library.xcframework
          ORIGINAL_NAME=$(find . -name "*.xcframework" | head -n 1)
          cp -rf "$ORIGINAL_NAME" ../ui-project/Library.xcframework
          
          # ğŸŸ¢ åŒæ—¶å…¼å®¹ UI é¡¹ç›®ä¸­æ‰€æœ‰å¯èƒ½çš„æ—§è·¯å¾„
          mkdir -p ../ui-project/Library/sing-box
          cp -rf "$ORIGINAL_NAME" ../ui-project/Library/sing-box/
          cp -rf "$ORIGINAL_NAME" ../ui-project/Libbox.xcframework

      # 3. ğŸ”´ ç»æ€ï¼šæ‰‹æœ¯çº§ä¿®æ”¹å·¥ç¨‹æ–‡ä»¶ï¼Œå½»åº•æ¶ˆé™¤ Code 65
      - name: Hard-Purge Extensions
        run: |
          cd ui-project
          # ç‰©ç†åˆ é™¤
          rm -rf Extension IntentsExtension WidgetExtension TVExtension FileProviderExtension Shared
          
          # æš´åŠ›ä¿®å‰ªï¼šä»å·¥ç¨‹æ–‡ä»¶ä¸­åˆ é™¤æ‰€æœ‰ Extension çš„ç¼–è¯‘é…ç½®
          sed -i '' '/Extension/d' sing-box.xcodeproj/project.pbxproj
          
          # é¢„è§£æä¾èµ–
          xcodebuild -resolvePackageDependencies

      # 4. ğŸŸ¢ Xcode æœ€ç»ˆåˆæˆ (æŒ‰ç…§æå–æ–‡ä»¶çš„ SFI æ–¹æ¡ˆ)
      - name: Xcode Synthesis
        run: |
          cd ui-project
          xcodebuild -project sing-box.xcodeproj \
                     -scheme SFI \
                     -configuration Release \
                     -sdk iphoneos \
                     CODE_SIGNING_ALLOWED=NO \
                     CODE_SIGNING_REQUIRED=NO \
                     CODE_SIGN_IDENTITY="" \
                     CODE_SIGN_ENTITLEMENTS="" \
                     GCC_PREPROCESSOR_DEFINITIONS='$GCC_PREPROCESSOR_DEFINITIONS SFI_MAIN_ONLY=1' \
                     clean archive -archivePath build/sing-box.xcarchive

      # 5. ğŸŸ¢ æ‰“åŒ… IPA (TrollStore ä¸“ç”¨)
      - name: Export IPA
        run: |
          mkdir -p Payload
          APP_PATH=$(find ui-project/build/sing-box.xcarchive -name "*.app" | head -n 1)
          cp -rp "$APP_PATH" Payload/
          zip -r sing-box-1.12.14-victory.ipa Payload/

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: SingBox-Match-Result
          path: sing-box-1.12.14-victory.ipa
