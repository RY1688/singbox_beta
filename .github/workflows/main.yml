name: Build SingBox 1.12.14 Final Victory
on: workflow_dispatch

jobs:
  build:
    runs-on: macos-14
    steps:
      # 1. ğŸŸ¢ å¼ºè¡Œå¯¹ä½ Java 17 (å½»åº•æ€æ‰ FATAL æŠ¥é”™)
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'microsoft'
          java-version: '17'

      # 2. ğŸŸ¢ é…ç½® Go ç¯å¢ƒå¹¶å¼€å¯ç¼“å­˜
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: true

      # 3. ğŸŸ¢ æºç å¼ºåˆ¶ç‰©ç†å¯¹ä½ (æ‰‹åŠ¨åˆ›å»ºéš”ç¦»æ–‡ä»¶å¤¹)
      - name: Clone Clean Source
        run: |
          mkdir -p $GITHUB_WORKSPACE/ui-project
          mkdir -p $GITHUB_WORKSPACE/core-source
          # ç‰©ç†éš”ç¦»å…‹éš†ï¼Œé˜²æ­¢æ–‡ä»¶å¤¹ååµŒå¥—å¯¼è‡´è·¯å¾„ä¸¢å¤±
          git clone https://github.com/SagerNet/sing-box-for-apple.git $GITHUB_WORKSPACE/ui-project
          git clone --branch v1.12.14 --depth 1 https://github.com/SagerNet/sing-box.git $GITHUB_WORKSPACE/core-source/singbox

      # 4. ğŸ”´ æ ¸å¿ƒç¼–è¯‘ï¼šè¿›å…¥åŒ…å« go.mod çš„ç‰©ç†ç»å¯¹æ ¹ç›®å½•
      - name: Build Core Framework (1.12.14 Native)
        run: |
          go install github.com/sagernet/gomobile/cmd/gomobile@latest
          go install github.com/sagernet/gomobile/cmd/gobind@latest
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
          $(go env GOPATH)/bin/gomobile init
          
          # ğŸŸ¢ å…³é”®ï¼šè¿›å…¥ç‰©ç†ç»å¯¹è·¯å¾„ï¼Œç¡®ä¿æ¨¡å—ä¸Šä¸‹æ–‡ 100% æ­£ç¡®
          cd $GITHUB_WORKSPACE/core-source/singbox
          
          # ğŸŸ¢ å…³é”®ï¼šè°ƒç”¨ 1.12.x å®˜æ–¹å†…éƒ¨æ„å»ºè„šæœ¬ï¼Œé¿å¼€ Bind Type Error
          go run ./cmd/apple framework -v
          
          # ğŸŸ¢ æ¬è¿æˆæœåˆ° UI é¡¹ç›®é¢„å®šå‘ä½
          mkdir -p $GITHUB_WORKSPACE/ui-project/Library/sing-box
          cp -rf *.xcframework $GITHUB_WORKSPACE/ui-project/Library/sing-box/

      # 5. ğŸŸ¢ æœ€ç»ˆ Xcode åˆæˆ (ä¸ä½¿ç”¨æœ‰é—®é¢˜çš„ make_ios.sh)
      - name: Final Xcode Synthesis
        run: |
          cd $GITHUB_WORKSPACE/ui-project
          # å½»åº•æ¸…é™¤å¹²æ‰°é¡¹
          rm -rf Extension IntentsExtension WidgetExtension TVExtension
          # å¼ºè¡Œæ„å»ºæ— ç­¾å IPA
          xcodebuild -project sing-box.xcodeproj \
                     -scheme SFI \
                     -configuration Release \
                     -sdk iphoneos \
                     CODE_SIGNING_ALLOWED=NO \
                     CODE_SIGNING_REQUIRED=NO \
                     FRAMEWORK_SEARCH_PATHS="$(pwd)/Library/sing-box" \
                     clean archive -archivePath build/sing-box.xcarchive

      # 6. ğŸŸ¢ å¯¼å‡º IPA
      - name: Export for TrollStore
        run: |
          mkdir -p Payload
          APP_PATH=$(find $GITHUB_WORKSPACE/ui-project/build/sing-box.xcarchive -name "*.app" | head -n 1)
          cp -rp "$APP_PATH" Payload/
          zip -r sing-box-1.12.14-stable.ipa Payload/

      - name: Upload Finished Result
        uses: actions/upload-artifact@v4
        with:
          name: SingBox-1.12.14-Success
          path: sing-box-1.12.14-stable.ipa
