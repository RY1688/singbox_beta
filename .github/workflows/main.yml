name: Build SingBox 1.12.14 Ultimate (Final Pass)
on: workflow_dispatch

jobs:
  build:
    # ğŸ”´ å…³é”®ï¼šå¿…é¡»ä½¿ç”¨ macOS 15 ä»¥æ”¯æŒ Xcode 16 é¡¹ç›®æ ¼å¼
    runs-on: macos-15
    steps:
      # 1. ğŸŸ¢ å¼ºè¡Œå¯¹ä½ Java 17 (å½»åº•æ€æ‰ FATAL æŠ¥é”™)
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'microsoft'
          java-version: '17'
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      # 2. ğŸŸ¢ æ ¸å¿ƒä¿®å¤ï¼šæ‹‰å–ç¨³å®šç‰ˆ UI å’Œ 1.12.14 ç¨³å®šç‰ˆå†…æ ¸
      - name: Clone Clean Source
        run: |
          # æ‹‰å– UI ä¸»åˆ†æ”¯
          git clone --recursive --depth 1 https://github.com/SagerNet/sing-box-for-apple.git ui-project
          # æ‹‰å– 1.12.14 å†…æ ¸æ ‡ç­¾
          git clone --branch v1.12.14 --depth 1 https://github.com/SagerNet/sing-box.git core-project

      # 3. ğŸŸ¢ ç¼–è¯‘å†…æ ¸é›¶ä»¶ (1.12.14 ç¨³å®šç‰ˆ)
      - name: Build Core Framework
        run: |
          go install github.com/sagernet/gomobile/cmd/gomobile@latest
          go install github.com/sagernet/gomobile/cmd/gobind@latest
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
          $(go env GOPATH)/bin/gomobile init
          
          cd core-project
          # ç›´æ¥å¯¹æ ¹æ¨¡å—è¿›è¡Œ bind æ“ä½œï¼Œç”Ÿæˆ 1.12.14 æ ¸å¿ƒé›¶ä»¶
          gomobile bind -v -target ios ./
          
          # ğŸ”´ ç‰©ç†å¯¹ä½ï¼šå¼ºè¡Œå‘½åä¸º Xcode æœŸå¾…çš„åç§°ï¼Œå¹¶å¡è¿› UI é¡¹ç›®
          ORIGINAL_FRAMEWORK=$(find . -name "*.xcframework" | head -n 1)
          cp -rf "$ORIGINAL_FRAMEWORK" ../ui-project/Libbox.xcframework
          
          mkdir -p ../ui-project/Library/sing-box
          cp -rf "$ORIGINAL_FRAMEWORK" ../ui-project/Library/sing-box/

      # 4. ğŸ”´ å…³é”®ä¿®å¤ï¼šå½»åº•å‰¥ç¦»ä¼šå¯¼è‡´ Exit code 65 çš„ç­¾åç»„ä»¶
      - name: Purge Disruptive Extensions
        run: |
          cd ui-project
          # å¼ºè¡Œç§»é™¤æ‰€æœ‰ä¼šå¯¼è‡´ç­¾åæŠ¥é”™çš„æ’ä»¶
          rm -rf Extension IntentsExtension WidgetExtension TVExtension FileProviderExtension Shared
          # å¼ºåˆ¶é¢„è§£æ Swift ä¾èµ–
          xcodebuild -resolvePackageDependencies

      # 5. ğŸŸ¢ Xcode æœ€ç»ˆåˆæˆ (æ— ç­¾å/çº¯å‡€æ¨¡å¼)
      - name: Xcode Synthesis
        run: |
          cd ui-project
          # ä½¿ç”¨çº¯å‡€æ¨¡å¼ç¼–è¯‘ SFI ä¸»æ–¹æ¡ˆï¼Œç¦ç”¨æ‰€æœ‰è‡ªåŠ¨ç­¾åå’Œç»„ä»¶é“¾æ¥
          xcodebuild -project sing-box.xcodeproj \
                     -scheme SFI \
                     -configuration Release \
                     -sdk iphoneos \
                     CODE_SIGNING_ALLOWED=NO \
                     CODE_SIGNING_REQUIRED=NO \
                     CODE_SIGN_IDENTITY="" \
                     CODE_SIGN_ENTITLEMENTS="" \
                     GCC_PREPROCESSOR_DEFINITIONS='$GCC_PREPROCESSOR_DEFINITIONS SFI_MAIN_ONLY=1' \
                     clean archive -archivePath build/sing-box.xcarchive

      # 6. ğŸŸ¢ äº§å‡ºæˆå“ IPA
      - name: Export IPA
        run: |
          mkdir -p Payload
          APP_PATH=$(find ui-project/build/sing-box.xcarchive -name "*.app" | head -n 1)
          cp -rp "$APP_PATH" Payload/
          zip -r sing-box-1.12.14-stable.ipa Payload/

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: SingBox-Result
          path: sing-box-1.12.14-stable.ipa
