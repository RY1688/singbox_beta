name: Build SingBox 1.12.14 (Final Victory)
on: workflow_dispatch

jobs:
  build:
    runs-on: macos-14
    steps:
      # 1. ğŸŸ¢ ä¿®å¤ç¯å¢ƒï¼šå¼ºåˆ¶ OpenJDK 17 (è§£å†³ä¹‹å‰æˆªå›¾çœ‹åˆ°çš„ FATAL æŠ¥é”™)
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'microsoft'
          java-version: '17'
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      # 2. ğŸŸ¢ å¹²å‡€æ‹‰å–å…¨å¥—æºç 
      - name: Clone Clean Source
        run: |
          git clone https://github.com/SagerNet/sing-box-for-apple.git main-app
          git clone --branch v1.12.14 --depth 1 https://github.com/SagerNet/sing-box.git core-src

      # 3. ğŸ”´ æ ¸å¿ƒä¿®å¤ï¼šå…¨ç›˜æœç´¢ç¼–è¯‘å…¥å£ (è§£å†³ directory not found)
      - name: Build Core (Auto-Locate Logic)
        run: |
          # å®‰è£…ç¼–è¯‘å·¥å…·
          go install github.com/sagernet/gomobile/cmd/gomobile@latest
          go install github.com/sagernet/gomobile/cmd/gobind@latest
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
          $(go env GOPATH)/bin/gomobile init
          
          # ğŸŸ¢ å…³é”®ï¼šä¸å†çŒœæµ‹è·¯å¾„ï¼Œç›´æ¥åœ¨å…‹éš†çš„æ‰€æœ‰å†…å®¹ä¸­å¯»æ‰¾ cmd/apple æ–‡ä»¶å¤¹
          REAL_CORE_DIR=$(find $(pwd)/core-src -name "apple" -type d | grep "cmd/apple" | head -n 1)
          
          if [ -z "$REAL_CORE_DIR" ]; then
            echo "Error: Could not find cmd/apple in the source tree."
            ls -R core-src # æ‰“å°ç›®å½•ç»“æ„ç”¨äºè°ƒè¯•
            exit 1
          fi
          
          echo "Found entry point at: $REAL_CORE_DIR"
          cd "$REAL_CORE_DIR"
          
          # ç°åœºç¼–è¯‘ 1.12.14 äºŒè¿›åˆ¶é›¶ä»¶
          go run . framework -v
          
          # æ¬è¿ç”Ÿæˆçš„æˆæœ
          cd $GITHUB_WORKSPACE
          mkdir -p main-app/Library/sing-box
          find core-src -name "*.xcframework" -exec cp -rf {} main-app/Library/sing-box/ \;

      # 4. ğŸŸ¢ æœ€ç»ˆåˆæˆ (æ›¿ä»£æœ‰é—®é¢˜çš„è„šæœ¬é€»è¾‘ï¼Œç›´æ¥ä½¿ç”¨æ ‡å‡† Xcode æ„å»º)
      - name: Final Xcode Synthesis
        run: |
          cd main-app
          # ç§»é™¤å¹²æ‰°é¡¹ç¡®ä¿çº¯å‡€ç¼–è¯‘
          rm -rf Extension IntentsExtension WidgetExtension TVExtension
          
          xcodebuild -project sing-box.xcodeproj \
                     -scheme SFI \
                     -configuration Release \
                     -sdk iphoneos \
                     CODE_SIGNING_ALLOWED=NO \
                     CODE_SIGNING_REQUIRED=NO \
                     FRAMEWORK_SEARCH_PATHS="$(pwd)/Library/sing-box" \
                     clean archive -archivePath build/sing-box.xcarchive

      - name: Pack IPA
        run: |
          mkdir -p Payload
          APP_PATH=$(find main-app/build/sing-box.xcarchive -name "*.app" | head -n 1)
          cp -rp "$APP_PATH" Payload/
          zip -r sing-box-1.12.14-stable.ipa Payload/

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: SingBox-Result
          path: sing-box-1.12.14-stable.ipa
